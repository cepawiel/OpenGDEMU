
cmake_path(GET CMAKE_CURRENT_LIST_DIR PARENT_PATH QUARTUS_SOURCE_DIR)
set(QUARTUS_BINARY_DIR ${CMAKE_CURRENT_BINARY_DIR})
message(STATUS "QUARTUS_SOURCE_DIR ${QUARTUS_SOURCE_DIR}")
message(STATUS "QUARTUS_BINARY_DIR ${QUARTUS_BINARY_DIR}")


set(QUARTUS_OUTPUT_RBF_FOLDER ${QUARTUS_BINARY_DIR}/quartus/output_files)
set(QUARTUS_OUTPUT_RBF ${QUARTUS_OUTPUT_RBF_FOLDER}/OpenGDEMU.rbf)

set(QUARTUS_OUTPUT_RBF ${QUARTUS_OUTPUT_RBF} PARENT_SCOPE)
set(QUARTUS_OUTPUT_RBF_FOLDER ${QUARTUS_OUTPUT_RBF_FOLDER} PARENT_SCOPE)


# FPGA Bitstream
set(QUARTUS_CONTAINER_ENV 
    -e INPUT_PATH=${QUARTUS_SOURCE_DIR}
    -e OUTPUT_PATH=${QUARTUS_BINARY_DIR}
    )
set(QUARTUS_CONTAINER_VOL
    -v ${QUARTUS_SOURCE_DIR}:${QUARTUS_SOURCE_DIR}:ro
    -v ${QUARTUS_BINARY_DIR}:${QUARTUS_BINARY_DIR}
    )
add_custom_command(
    OUTPUT ${QUARTUS_OUTPUT_RBF}
    COMMAND ${Docker_EXECUTABLE} run ${QUARTUS_CONTAINER_VOL} ${QUARTUS_CONTAINER_ENV} --rm quartus13 quartus_sh --flow compile quartus/OpenGDEMU
    DEPENDS
        ${verilog_SOURCES}
        ${QUARTUS_IMAGE_HASH}
        ${GENERATED_VERILOG_OUTPUT}
    )
add_custom_target(OpenGDEMU_rbf DEPENDS ${QUARTUS_OUTPUT_RBF})

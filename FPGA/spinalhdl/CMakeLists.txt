project(SpinalHDL_OpenGDEMU)

file(GLOB_RECURSE spinal_SOURCES ${CMAKE_CURRENT_LIST_DIR}/src/*.scala)


set(GENERATED_VERILOG_OUTPUT ${CMAKE_CURRENT_LIST_DIR}/OpenGDEMU.v)
set(GENERATED_VERILOG_OUTPUT ${GENERATED_VERILOG_OUTPUT} PARENT_SCOPE)

set(SPINALHDL_CONTAINER_VOL -v ${CMAKE_CURRENT_LIST_DIR}:${CMAKE_CURRENT_LIST_DIR} -v ${CMAKE_CURRENT_BINARY_DIR}/out:${CMAKE_CURRENT_LIST_DIR}/out)

set(SPINALHDL_COMMAND opengdemu.runMain opengdemu.OpenGDEMUVerilog ${CMAKE_CURRENT_LIST_DIR})
 
set(SPINALHDL_DOCKER_CMD ${Docker_EXECUTABLE} run ${SPINALHDL_CONTAINER_VOL} -w ${CMAKE_CURRENT_LIST_DIR} spinalhdl ${SPINALHDL_COMMAND})
message(STATUS ${SPINALHDL_DOCKER_CMD})

add_custom_command(
    OUTPUT ${GENERATED_VERILOG_OUTPUT}
    COMMAND ${SPINALHDL_DOCKER_CMD}
    VERBATIM
    DEPENDS
        ${SPINALHDL_IMAGE_HASH}
        ${spinal_SOURCES}
    )

add_custom_target(spinalhdl_gen DEPENDS ${GENERATED_VERILOG_OUTPUT})

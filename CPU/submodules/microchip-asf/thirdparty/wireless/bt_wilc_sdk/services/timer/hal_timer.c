#include "asf.h"
#include "hal_tick.h"
#include "hal_time_ms.h"
#include "btstack_run_loop.h"

static void dummy_handler(void){}
static void (*tick_handler)(void) = &dummy_handler;

/**
 * \brief Wait for the given number of milliseconds (ticks
 * generated by the SAM's microcontrollers's system tick).
 *
 * \param ul_dly_ticks  Delay to wait for, in milliseconds.
 */
// [main_ms_delay]
void mdelay(uint32_t delay_in_ms)
{
	// delay_ms(delay_in_ms);
	uint32_t time_to_wait = btstack_run_loop_get_time_ms() + delay_in_ms;
	while (btstack_run_loop_get_time_ms() < time_to_wait);
}
// [main_ms_delay]

void hal_tick_init()
{
	/* Configure systick for 1 ms */
	puts("\r\nConfigure system tick to get 1ms tick period.\n");
	if (SysTick_Config(sysclk_get_cpu_hz() / 1000)) {
		puts("\r\n-F- Systick configuration error\n");
		while (1);
	}
}

void hal_tick_set_handler(void (*handler)(void)){
	if (handler == NULL){
		tick_handler = &dummy_handler;
		return;
	}
	tick_handler = handler;
}

int  hal_tick_get_tick_period_in_ms(void){
	return 1;
}

uint32_t hal_time_ms(void)
{
	return (xTaskGetTickCount()*2);
}